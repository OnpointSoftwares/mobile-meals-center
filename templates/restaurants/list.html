{% extends 'base.html' %}
{% load static %}

{% block title %}Restaurants - Mobile Meals Center{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="text-center">
                <h1 class="fw-bold mb-3">
                    <i class="bi bi-shop me-2 text-primary"></i>Discover Amazing Restaurants
                </h1>
                <p class="lead text-muted mb-4">
                    From local favorites to gourmet cuisine, find the perfect restaurant for your cravings
                </p>
                
                <!-- Search and Filter Bar -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <form method="get" class="d-flex gap-3 mb-4">
                            <div class="flex-fill">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" name="search" 
                                           placeholder="Search restaurants by name or cuisine..." 
                                           value="{{ request.GET.search }}">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i>Search
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Info -->
    {% if restaurants %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        {% if request.GET.search %}
                            Search Results for "{{ request.GET.search }}"
                        {% else %}
                            All Restaurants
                        {% endif %}
                    </h5>
                    <small class="text-muted">{{ restaurants|length }} restaurant{{ restaurants|length|pluralize }} found</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="grid-view" onclick="toggleView('grid')">
                        <i class="bi bi-grid-3x3-gap"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="list-view" onclick="toggleView('list')">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Restaurants Grid/List -->
    <div class="row g-4" id="restaurants-container">
        {% for restaurant in restaurants %}
        <div class="col-lg-4 col-md-6 restaurant-item">
            <div class="card h-100 hover-lift">
                <!-- Restaurant Image -->
                <div class="position-relative">
                    {% if restaurant.logo %}
                    <img src="{{ restaurant.logo.url }}" class="card-img-top" alt="{{ restaurant.name }}" style="height: 250px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 250px;">
                        <i class="bi bi-shop display-4 text-muted"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Status Badge -->
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>Open
                        </span>
                    </div>
                    
                    <!-- Rating Badge -->
                    <div class="position-absolute bottom-0 start-0 m-3">
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-star-fill me-1"></i>4.5
                        </span>
                    </div>
                </div>
                
                <div class="card-body d-flex flex-column">
                    <div class="mb-3">
                        <h5 class="card-title mb-2">{{ restaurant.name }}</h5>
                        <p class="card-text text-muted small mb-2">{{ restaurant.description|truncatechars:100 }}</p>
                        
                        <!-- Location -->
                        <div class="d-flex align-items-center text-muted small mb-2">
                            <i class="bi bi-geo-alt me-1"></i>
                            <span>{{ restaurant.address|default:"Location not specified" }}</span>
                        </div>
                        
                        <!-- Cuisine Type -->
                        <div class="d-flex align-items-center text-muted small mb-3">
                            <i class="bi bi-tag me-1"></i>
                            <span>{{ restaurant.cuisine_type|default:"Various Cuisines" }}</span>
                        </div>
                    </div>
                    
                    <!-- Restaurant Stats -->
                    <div class="row g-2 mb-3 text-center">
                        <div class="col-4">
                            <div class="bg-light rounded p-2">
                                <div class="fw-bold text-primary">{{ restaurant.meals.count }}</div>
                                <small class="text-muted">Meals</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-light rounded p-2">
                                <div class="fw-bold text-success">4.5</div>
                                <small class="text-muted">Rating</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-light rounded p-2">
                                <div class="fw-bold text-info">25min</div>
                                <small class="text-muted">Delivery</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-auto">
                        <div class="d-grid gap-2">
                            <a href="{% url 'restaurants:detail' pk=restaurant.pk %}" class="btn btn-primary">
                                <i class="bi bi-eye me-2"></i>View Menu
                            </a>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success btn-sm flex-fill" onclick="callRestaurant('{{ restaurant.phone }}')">
                                    <i class="bi bi-telephone me-1"></i>Call
                                </button>
                                <button class="btn btn-outline-info btn-sm flex-fill" onclick="getDirections('{{ restaurant.latitude }}', '{{ restaurant.longitude }}')">
                                    <i class="bi bi-geo-alt me-1"></i>Directions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Restaurants pagination" class="mt-5">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Previous</a>
            </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Last &raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
        <div class="mb-4">
            {% if request.GET.search %}
            <i class="bi bi-search display-1 text-muted"></i>
            <h3 class="text-muted mb-3">No restaurants found</h3>
            <p class="text-muted mb-4">We couldn't find any restaurants matching "{{ request.GET.search }}". Try a different search term.</p>
            <a href="{% url 'restaurants:list' %}" class="btn btn-primary">
                <i class="bi bi-arrow-left me-2"></i>View All Restaurants
            </a>
            {% else %}
            <i class="bi bi-shop display-1 text-muted"></i>
            <h3 class="text-muted mb-3">No restaurants available</h3>
            <p class="text-muted mb-4">There are no restaurants registered yet. Check back later!</p>
            {% if user.is_authenticated %}
            <a href="{% url 'restaurants:create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Register Your Restaurant
            </a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Call to Action Section -->
<section class="bg-light py-5 mt-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h3 class="fw-bold mb-2">Own a Restaurant?</h3>
                <p class="text-muted mb-0">Join Mobile Meals Center and reach thousands of hungry customers in your area.</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <a href="{% url 'restaurants:create' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>Join as Partner
                </a>
            </div>
        </div>
    </div>
</section>

<script>
// View Toggle Functionality
function toggleView(viewType) {
    const container = document.getElementById('restaurants-container');
    const gridBtn = document.getElementById('grid-view');
    const listBtn = document.getElementById('list-view');
    const items = document.querySelectorAll('.restaurant-item');
    
    if (viewType === 'list') {
        // List view
        items.forEach(item => {
            item.className = 'col-12 restaurant-item';
            const card = item.querySelector('.card');
            card.classList.add('mb-3');
            
            // Modify card structure for list view
            const cardBody = card.querySelector('.card-body');
            const img = card.querySelector('.card-img-top, .card-img-top + div');
            
            if (img && cardBody) {
                card.classList.add('d-md-flex', 'flex-md-row');
                img.style.width = '200px';
                img.style.height = '150px';
                cardBody.classList.add('flex-fill');
            }
        });
        
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
    } else {
        // Grid view
        items.forEach(item => {
            item.className = 'col-lg-4 col-md-6 restaurant-item';
            const card = item.querySelector('.card');
            card.classList.remove('mb-3', 'd-md-flex', 'flex-md-row');
            
            const img = card.querySelector('.card-img-top, .card-img-top + div');
            const cardBody = card.querySelector('.card-body');
            
            if (img) {
                img.style.width = '';
                img.style.height = '250px';
            }
            if (cardBody) {
                cardBody.classList.remove('flex-fill');
            }
        });
        
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
    }
}

// Initialize grid view
document.addEventListener('DOMContentLoaded', function() {
    toggleView('grid');
});

// Call Restaurant
function callRestaurant(phone) {
    if (phone) {
        window.location.href = 'tel:' + phone;
    } else {
        alert('Phone number not available for this restaurant.');
    }
}

// Get Directions
function getDirections(lat, lng) {
    if (lat && lng) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(url, '_blank');
    } else {
        alert('Location not available for this restaurant.');
    }
}
</script>
{% endblock %}
